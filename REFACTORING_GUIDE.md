# Руководство по рефакторингу системы справочников

## Обзор изменений

Было выполнено масштабное рефакторирование приложения для поддержки множественных справочников оценки недвижимости. Теперь приложение поддерживает:

- Множественные справочники (2025, 2024, и др.)
- Различные типы недвижимости (квартиры, дома)
- Легкое добавление новых справочников без изменения основного кода

## Архитектура после рефакторинга

### 1. Центральное хранилище справочников (`src/data/dataSources.js`)

**Назначение**: Единое место для хранения всех справочников с их данными и логикой.

**Структура справочника**:
```javascript
const HANDBOOK_EXAMPLE = {
  id: 'unique_id',           // Уникальный идентификатор
  name: 'Отображаемое имя',  // Название для UI
  description: 'Описание',   // Описание справочника
  
  data: {
    // Все данные справочника (коэффициенты, скидки, и т.д.)
    TRADE_DISCOUNTS: {...},
    LOCATION_COEFFICIENTS: {...},
    // ... остальные данные
  },
  
  logic: {
    // Все функции для работы с данными этого справочника
    calcTradeMultiplier(percent) {...},
    resolveLocationRegionKey(region) {...},
    // ... остальные функции
  }
}
```

### 2. Обновленный App.jsx

**Изменения**:
- Добавлен выбор справочника в UI
- Все вычисления теперь используют логику выбранного справочника
- Автоматический сброс зависимых полей при смене справочника

**Ключевые изменения**:
```javascript
// Получение текущего справочника
const currentHandbook = DATA_SOURCES[selectedHandbookId];

// Использование логики справочника
const locationOptions = useMemo(() => {
  const group = locationRegionKey ? 
    currentHandbook?.data.LOCATION_COEFFICIENTS[locationRegionKey]?.[locationFundKey] : null;
  return group ? Object.keys(group) : [];
}, [locationRegionKey, locationFundKey, currentHandbook]);
```

### 3. Обновленный useAnalogCalculator.js

**Изменения**:
- Принимает справочник как параметр
- Все вычисления используют логику переданного справочника
- Полная независимость от конкретных данных

**Ключевые изменения**:
```javascript
export const useAnalogCalculator = (...params, handbook) => {
  // Использование данных из справочника
  const tradeAvgPercent = useMemo(() => {
    if (!handbook) return null;
    const regionData = handbook.data.TRADE_DISCOUNTS[selectedRegion];
    return handbook.logic.parsePercentToNumber(regionData[selectedFund]);
  }, [selectedRegion, selectedFund, handbook]);
}
```

### 4. Очищенный utils/calculations.js

**Текущее состояние**: Содержит только универсальные функции + временные экспорты для обратной совместимости.

**Универсальные функции**:
- `parseNumber()` - парсинг чисел
- `formatNumber()` - форматирование чисел
- `parsePercentToNumber()` - парсинг процентов
- `calcAreaMultiplier()` - расчет корректировки на площадь

## Добавление нового справочника

### Шаг 1: Создание структуры справочника

```javascript
const NEW_HANDBOOK = {
  id: 'unique_handbook_id',
  name: 'Название справочника',
  description: 'Описание справочника',
  
  data: {
    // Скопируйте структуру из существующего справочника
    // и измените нужные значения
    INITIAL_ANALOG: {...},
    TRADE_DISCOUNTS: {...},
    LOCATION_COEFFICIENTS: {...},
    // ... остальные данные
  },
  
  logic: {
    // Можно наследовать логику от существующего справочника
    ...EXISTING_HANDBOOK.logic,
    
    // И переопределить только нужные функции
    calcTradeMultiplier(avgPercentNumber) {
      // Своя логика расчета
    }
  }
};
```

### Шаг 2: Регистрация в DATA_SOURCES

```javascript
export const DATA_SOURCES = {
  [HANDBOOK_2025.id]: HANDBOOK_2025,
  [NEW_HANDBOOK.id]: NEW_HANDBOOK,  // Добавить здесь
};
```

### Шаг 3: Тестирование

Справочник автоматически появится в выпадающем списке приложения и будет готов к использованию.

## Примеры существующих справочников

### 1. HANDBOOK_2025 (Лейфер 2025 Квартиры)
- Базовый справочник с полными данными
- Все оригинальные коэффициенты и логика

### 2. HANDBOOK_2024 (Лейфер 2024 Квартиры) 
- Наследует данные от 2025
- Изменены торговые скидки для демонстрации

### 3. HANDBOOK_HOUSES_2025 (Лейфер 2025 Жилые дома)
- Пример кардинально другого типа недвижимости
- Новые поля (площадь земли)
- Другие коэффициенты и логика

## Преимущества новой архитектуры

1. **Масштабируемость**: Легко добавлять новые справочники
2. **Изоляция**: Каждый справочник независим
3. **Переиспользование**: Логика может наследоваться
4. **Обратная совместимость**: Старый код продолжает работать
5. **Типобезопасность**: Четкая структура данных

## Будущие улучшения

1. **Удаление временных экспортов** из `utils/calculations.js`
2. **Валидация справочников** при загрузке
3. **Динамическая загрузка** справочников из API
4. **Версионирование** справочников
5. **Миграции** между версиями справочников

## Техническая совместимость

- ✅ Сохранен весь оригинальный UX/UI
- ✅ Сохранена вся бизнес-логика
- ✅ Приложение собирается без ошибок
- ✅ Все расчеты работают корректно
- ✅ Добавлена возможность выбора справочника

Рефакторинг завершен успешно и готов к продакшену.
