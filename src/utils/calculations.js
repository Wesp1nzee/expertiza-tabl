// utils/calculations.js
// Универсальные функции расчета, не зависящие от конкретного справочника
// + экспорт всех данных для обратной совместимости

/**
 * Парсит числовое значение, возвращает 0 для невалидных значений
 */
export function parseNumber(value) {
  if (value === '' || value === null || value === undefined) return 0;
  const n = Number(value);
  return Number.isFinite(n) ? n : 0;
}

/**
 * Форматирует число с заданным количеством знаков после запятой
 */
export function formatNumber(n, digits = 2) {
  if (!Number.isFinite(n)) return '';
  return n.toFixed(digits);
}

/**
 * Парсит процентную строку в число
 */
export function parsePercentToNumber(percentString) {
  if (!percentString || percentString === '-') return null;
  const cleaned = String(percentString).replace('%', '').trim();
  const num = Number(cleaned);
  return Number.isFinite(num) ? num : null;
}

/**
 * Универсальный расчет корректировки на площадь квартиры
 * Использует формулу: (S_оо / S_оа)^(-0.06)
 */
export function calcAreaMultiplier(evaluatedArea, analogArea) {
  const S_OO = Number(evaluatedArea);
  const S_OA = Number(analogArea);
  if (!Number.isFinite(S_OO) || !Number.isFinite(S_OA) || S_OO <= 0 || S_OA <= 0) return null;
  const raw = Math.pow(S_OO / S_OA, -0.06);
  return Math.round(raw * 10000) / 10000;
}

/**
 * Рассчитывает корректировку на торг
 */
export function calcTradeMultiplier(avgPercentNumber) {
  if (avgPercentNumber === null) return null;
  const fraction = avgPercentNumber / 100;
  const multiplier = 1 - fraction;
  return Math.round(multiplier * 10000) / 10000;
}

// --- Константы и справочники ---

export const INITIAL_ANALOG = {
  priceOfferThousand: '',
  areaSqm: '',
  adjRights: 1,
  adjFinance: 1,
  adjSaleDate: 1,
  adjTrade: 1,
  adjLocation: 1,
  adjArea: 1,
  adjWalls: 1,
  adjCommunications: 1,
  adjHouseCondition: 1,
  adjFloors: 1,
  adjFlatCondition: 1,
  adjBalcony: 1,
  units: '',
  __analogWall: '',
  __analogHouseCondition: '',
  __analogFlatCondition: '',
  __analogBalcony: '',
  __analogFloor: '',
};

export const TRADE_DISCOUNTS = {
  'Москва': {
    'Старый фонд': '9.4%',
    'Массовое жилье советской постройки': '8.4%',
    'Массовое современное жилье': '7.7%',
    'Жилье повышенной комфортности': '7.9%',
  },
  'Московская область': {
    'Старый фонд': '10.8%',
    'Массовое жилье советской постройки': '9.8%',
    'Массовое современное жилье': '7.3%',
    'Жилье повышенной комфортности': '-',
  },
  'Города с численностью населения более 1 млн чел. (кроме Москвы и Санкт-Петербурга)': {
    'Старый фонд': '9.5%',
    'Массовое жилье советской постройки': '8.3%',
    'Массовое современное жилье': '7.1%',
    'Жилье повышенной комфортности': '7.7%',
  },
  'Города с численностью населения 500-1000 тыс. чел.': {
    'Старый фонд': '9.9%',
    'Массовое жилье советской постройки': '8.5%',
    'Массовое современное жилье': '7.6%',
    'Жилье повышенной комфортности': '8.1%',
  },
  'Города с численностью населения до 500 тыс. чел.': {
    'Старый фонд': '9.8%',
    'Массовое жилье советской постройки': '8.8%',
    'Массовое современное жилье': '7.6%',
    'Жилье повышенной комфортности': '8.1%',
  },
  'Курортные регионы': {
    'Старый фонд': '11.5%',
    'Массовое жилье советской постройки': '-',
    'Массовое современное жилье': '-',
    'Жилье повышенной комфортности': '9.5%',
  },
};

export const LOCATION_COEFFICIENTS = {
  'Москва': {
    'Старый фонд, Массовое жилье советской постройки, Массовое современное жилье': {
      'Культурный и исторический центр': 1.0,
      'Центры деловой активности, зоны точечной застройки': 0.91,
      'Спальные микрорайоны современной высотной застройки, жилые кварталы': 0.85,
      'Спальные микрорайоны среднеэтажной застройки': 0.79,
      'Окраины городов, промзоны': 0.71,
    },
    'Жилые повышенной комфортности': {
      'Культурный и исторический центр': 1.0,
      'Центры деловой активности, зоны точечной застройки': 0.91,
      'Спальные микрорайоны современной высотной застройки, жилые кварталы': 0.86,
      'Спальные микрорайоны среднеэтажной застройки': 0.80,
      'Окраины городов, промзоны': 0.73,
    },
  },
  'Московская область': {
    'Старый фонд, Массовое жилье советской постройки, Массовое современное жилье': {
      'Культурный и исторический центр': 1.0,
      'Центры деловой активности, зоны точечной застройки': 0.94,
      'Спальные микрорайоны современной высотной застройки, жилые кварталы': 0.88,
      'Спальные микрорайоны среднеэтажной застройки': 0.84,
      'Окраины городов, промзоны': 0.73,
    },
    'Жилые повышенной комфортности': {
      'Культурный и исторический центр': 1.0,
      'Центры деловой активности, зоны точечной застройки': 0.95,
      'Спальные микрорайоны современной высотной застройки, жилые кварталы': 0.89,
      'Спальные микрорайоны среднеэтажной застройки': 0.85,
      'Окраины городов, промзоны': 0.77,
    },
  },
  'Города с численностью населения более 1 млн человек (кроме Москвы и Санкт-Петербурга)': {
    'Старый фонд, Массовое жилье советской постройки, Массовое современное жилье': {
      'Культурный и исторический центр': 1.0,
      'Центры деловой активности, зоны точечной застройки': 0.92,
      'Спальные микрорайоны современной высотной застройки, жилые кварталы': 0.85,
      'Спальные микрорайоны среднеэтажной застройки': 0.79,
      'Окраины городов, промзоны': 0.68,
    },
    'Жилые повышенной комфортности': {
      'Культурный и исторический центр': 1.0,
      'Центры деловой активности, зоны точечной застройки': 0.93,
      'Спальные микрорайоны современной высотной застройки, жилые кварталы': 0.88,
      'Спальные микрорайоны среднеэтажной застройки': 0.82,
      'Окраины городов, промзоны': 0.74,
    },
  },
  'Города с численностью населения 500-1000 тыс. человек': {
    'Старый фонд, Массовое жилье советской постройки, Массовое современное жилье': {
      'Культурный и исторический центр': 1.0,
      'Центры деловой активности, зоны точечной застройки': 0.91,
      'Спальные микрорайоны современной высотной застройки, жилые кварталы': 0.86,
      'Спальные микрорайоны среднеэтажной застройки': 0.80,
      'Окраины городов, промзоны': 0.70,
    },
    'Жилые повышенной комфортности': {
      'Культурный и исторический центр': 1.0,
      'Центры деловой активности, зоны точечной застройки': 0.92,
      'Спальные микрорайоны современной высотной застройки, жилые кварталы': 0.87,
      'Спальные микрорайоны среднеэтажной застройки': 0.82,
      'Окраины городов, промзоны': 0.75,
    },
  },
  'Города с численностью населения менее 500 тыс. человек': {
    'Старый фонд, Массовое жилье советской постройки, Массовое современное жилье': {
      'Культурный и исторический центр': 1.0,
      'Центры деловой активности, зоны точечной застройки': 0.92,
      'Спальные микрорайоны современной высотной застройки, жилые кварталы': 0.86,
      'Спальные микрорайоны среднеэтажной застройки': 0.81,
      'Окраины городов, промзоны': 0.70,
    },
    'Жилые повышенной комфортности': {
      'Культурный и исторический центр': 1.0,
      'Центры деловой активности, зоны точечной застройки': 0.93,
      'Спальные микрорайоны современной высотной застройки, жилые кварталы': 0.87,
      'Спальные микрорайоны среднеэтажной застройки': 0.81,
      'Окраины городов, промзоны': 0.74,
    },
  },
  'Курортные регионы': {
    'Старый фонд, Массовое жилье советской постройки, Массовое современное жилье': {
      'Культурный и исторический центр': 1.0,
      'Центры деловой активности, зоны точечной застройки': 0.89,
      'Спальные микрорайоны современной высотной застройки, жилые кварталы': 0.82,
      'Спальные микрорайоны среднеэтажной застройки': 0.79,
      'Окраины городов, промзоны': 0.67,
    },
    'Жилые повышенной комфортности': {
      'Культурный и исторический центр': 1.0,
      'Центры деловой активности, зоны точечной застройки': 0.89,
      'Спальные микрорайоны современной высотной застройки, жилые кварталы': 0.83,
      'Спальные микрорайоны среднеэтажной застройки': 0.79,
      'Окраины городов, промзоны': 0.72,
    },
  },
};

export const REGION_ALIASES_FOR_LOCATION = {
  'Города с численностью населения более 1 млн чел. (кроме Москвы и Санкт-Петербурга)': 'Города с численностью населения более 1 млн человек (кроме Москвы и Санкт-Петербурга)',
  'Города с численностью населения 500-1000 тыс. чел.': 'Города с численностью населения 500-1000 тыс. человек',
  'Города с численностью населения до 500 тыс. чел.': 'Города с численностью населения менее 500 тыс. человек',
};

// === НОВАЯ СТРУКТУРА: УСРЕДНЁННЫЕ КОЭФФИЦИЕНТЫ ПО СТЕНАМ (БЕЗ РЕГИОНА) ===

export const AVERAGE_WALL_MATERIAL_COEFFICIENTS = {
  'Старый фонд': {
    'кирпичные стены': {
      'кирпичные стены': 1.00,
      'шлакоблочные стены': 1.17,
      'деревянные стены': 1.35,
    },
    'шлакоблочные стены': {
      'кирпичные стены': 0.86,
      'шлакоблочные стены': 1.00,
      'деревянные стены': 1.16,
    },
    'деревянные стены': {
      'кирпичные стены': 0.74,
      'шлакоблочные стены': 0.86,
      'деревянные стены': 1.00,
    },
  },
  'Массовое жилье советской постройки, Массовое современное жилье, Жилье повышенной комфортности': {
    'кирпичные стены': {
      'кирпичные стены': 1.00,
      'монолитные стены': 1.06,
      'панельные стены': 1.08,
    },
    'монолитные стены': {
      'кирпичные стены': 0.95,
      'монолитные стены': 1.00,
      'панельные стены': 1.02,
    },
    'панельные стены': {
      'кирпичные стены': 0.92,
      'монолитные стены': 0.98,
      'панельные стены': 1.00,
    },
  },
};

// === ОСТАЛЬНЫЕ СПРАВОЧНИКИ (БЕЗ ИЗМЕНЕНИЙ) ===

export const HOUSE_CONDITION_COEFFICIENTS = {
  'Москва': {
    'Старый фонд, Массовое жилье советской постройки, Массовое современное жилье': {
      'объект_оценки': {
        'хорошее': {
          'аналог_хорошее': 1.0,
          'аналог_удовл': 1.17,
          'аналог_неудовл': 1.31,
        },
        'удовл': {
          'аналог_хорошее': 0.85,
          'аналог_удовл': 1.0,
          'аналог_неудовл': 1.12,
        },
        'неудовл': {
          'аналог_хорошее': 0.77,
          'аналог_удовл': 0.90,
          'аналог_неудовл': 1.0,
        },
      },
    },
  },
  'Московская область': {
    'Старый фонд, Массовое жилье советской постройки, Массовое современное жилье': {
      'объект_оценки': {
        'хорошее': {
          'аналог_хорошее': 1.0,
          'аналог_удовл': 1.19,
          'аналог_неудовл': 1.40,
        },
        'удовл': {
          'аналог_хорошее': 0.84,
          'аналог_удовл': 1.0,
          'аналог_неудовл': 1.18,
        },
        'неудовл': {
          'аналог_хорошее': 0.71,
          'аналог_удовл': 0.85,
          'аналог_неудовл': 1.0,
        },
      },
    },
  },
  'Города с численностью населения более 1 млн человек (кроме Москвы и Санкт-Петербурга)': {
    'Старый фонд, Массовое жилье советской постройки, Массовое современное жилье': {
      'объект_оценки': {
        'хорошее': {
          'аналог_хорошее': 1.0,
          'аналог_удовл': 1.17,
          'аналог_неудовл': 1.38,
        },
        'удовл': {
          'аналог_хорошее': 0.85,
          'аналог_удовл': 1.0,
          'аналог_неудовл': 1.17,
        },
        'неудовл': {
          'аналог_хорошее': 0.73,
          'аналог_удовл': 0.85,
          'аналог_неудовл': 1.0,
        },
      },
    },
  },
  'Города с численностью населения 500-1000 тыс. человек': {
    'Старый фонд, Массовое жилье советской постройки, Массовое современное жилье': {
      'объект_оценки': {
        'хорошее': {
          'аналог_хорошее': 1.0,
          'аналог_удовл': 1.20,
          'аналог_неудовл': 1.39,
        },
        'удовл': {
          'аналог_хорошее': 0.83,
          'аналог_удовл': 1.0,
          'аналог_неудовл': 1.16,
        },
        'неудовл': {
          'аналог_хорошее': 0.72,
          'аналог_удовл': 0.86,
          'аналог_неудовл': 1.0,
        },
      },
    },
  },
  'Города с численностью населения менее 500 тыс. человек': {
    'Старый фонд, Массовое жилье советской постройки, Массовое современное жилье': {
      'объект_оценки': {
        'хорошее': {
          'аналог_хорошее': 1.0,
          'аналог_удовл': 1.19,
          'аналог_неудовл': 1.38,
        },
        'удовл': {
          'аналог_хорошее': 0.84,
          'аналог_удовл': 1.0,
          'аналог_неудовл': 1.16,
        },
        'неудовл': {
          'аналог_хорошее': 0.73,
          'аналог_удовл': 0.86,
          'аналог_неудовл': 1.0,
        },
      },
    },
  },
  'Курортные регионы': {
    'Старый фонд, Массовое жилье советской постройки, Массовое современное жилье': {
      'объект_оценки': {
        'хорошее': {
          'аналог_хорошее': 1.0,
          'аналог_удовл': 1.23,
          'аналог_неудовл': 1.47,
        },
        'удовл': {
          'аналог_хорошее': 0.82,
          'аналог_удовл': 1.0,
          'аналог_неудовл': 1.20,
        },
        'неудовл': {
          'аналог_хорошее': 0.68,
          'аналог_удовл': 0.84,
          'аналог_неудовл': 1.0,
        },
      },
    },
  },
};

export const REGION_ALIASES_FOR_HOUSE_CONDITION = {
  'Города с численностью населения более 1 млн чел. (кроме Москвы и Санкт-Петербурга)': 'Города с численностью населения более 1 млн человек (кроме Москвы и Санкт-Петербурга)',
  'Города с численностью населения 500-1000 тыс. чел.': 'Города с численностью населения 500-1000 тыс. человек',
  'Города с численностью населения до 500 тыс. чел.': 'Города с численностью населения менее 500 тыс. человек',
};

export const FLAT_CONDITION_COEFFICIENTS = {
  'Москва': {
    'объект_оценки': {
      'комфортный ремонт (отделка «премиум»)': {
        'аналог_комфортный ремонт (отделка «премиум»)': 1.0,
        'аналог_типовой ремонт (отделка «стандарт»)': 1.14,
        'аналог_требует косметического ремонта (в т.ч. под чистовую отделку)': 1.24,
        'аналог_требует капитального ремонта (в т.ч. без отделки)': 1.35,
      },
      'типовой ремонт (отделка «стандарт»)': {
        'аналог_комфортный ремонт (отделка «премиум»)': 0.88,
        'аналог_типовой ремонт (отделка «стандарт»)': 1.0,
        'аналог_требует косметического ремонта (в т.ч. под чистовую отделку)': 1.09,
        'аналог_требует капитального ремонта (в т.ч. без отделки)': 1.19,
      },
      'требует косметического ремонта (в т.ч. под чистовую отделку)': {
        'аналог_комфортный ремонт (отделка «премиум»)': 0.81,
        'аналог_типовой ремонт (отделка «стандарт»)': 0.82,
        'аналог_требует косметического ремонта (в т.ч. под чистовую отделку)': 1.0,
        'аналог_требует капитального ремонта (в т.ч. без отделки)': 1.09,
      },
      'требует капитального ремонта (в т.ч. без отделки)': {
        'аналог_комфортный ремонт (отделка «премиум»)': 0.84,
        'аналог_типовой ремонт (отделка «стандарт»)': 0.92,
        'аналог_требует косметического ремонта (в т.ч. под чистовую отделку)': 1.0,
        'аналог_требует капитального ремонта (в т.ч. без отделки)': 1.0,
      },
    },
  },
  'Московская область': {
    'объект_оценки': {
      'комфортный ремонт (отделка «премиум»)': {
        'аналог_комфортный ремонт (отделка «премиум»)': 1.0,
        'аналог_типовой ремонт (отделка «стандарт»)': 1.17,
        'аналог_требует косметического ремонта (в т.ч. под чистовую отделку)': 1.23,
        'аналог_требует капитального ремонта (в т.ч. без отделки)': 1.33,
      },
      'типовой ремонт (отделка «стандарт»)': {
        'аналог_комфортный ремонт (отделка «премиум»)': 0.85,
        'аналог_типовой ремонт (отделка «стандарт»)': 1.0,
        'аналог_требует косметического ремонта (в т.ч. под чистовую отделку)': 1.13,
        'аналог_требует капитального ремонта (в т.ч. без отделки)': 1.13,
      },
      'требует косметического ремонта (в т.ч. под чистовую отделку)': {
        'аналог_комфортный ремонт (отделка «премиум»)': 0.81,
        'аналог_типовой ремонт (отделка «стандарт»)': 0.95,
        'аналог_требует косметического ремонта (в т.ч. под чистовую отделку)': 1.0,
        'аналог_требует капитального ремонта (в т.ч. без отделки)': 1.08,
      },
      'требует капитального ремонта (в т.ч. без отделки)': {
        'аналог_комфортный ремонт (отделка «премиум»)': 0.75,
        'аналог_типовой ремонт (отделка «стандарт»)': 0.88,
        'аналог_требует косметического ремонта (в т.ч. под чистовую отделку)': 0.92,
        'аналог_требует капитального ремонта (в т.ч. без отделки)': 1.0,
      },
    },
  },
  'Города с численностью населения более 1 млн человек (кроме Москвы и Санкт-Петербурга)': {
    'объект_оценки': {
      'комфортный ремонт (отделка «премиум»)': {
        'аналог_комфортный ремонт (отделка «премиум»)': 1.0,
        'аналог_типовой ремонт (отделка «стандарт»)': 1.13,
        'аналог_требует косметического ремонта (в т.ч. под чистовую отделку)': 1.22,
        'аналог_требует капитального ремонта (в т.ч. без отделки)': 1.34,
      },
      'типовой ремонт (отделка «стандарт»)': {
        'аналог_комфортный ремонт (отделка «премиум»)': 0.89,
        'аналог_типовой ремонт (отделка «стандарт»)': 1.0,
        'аналог_требует косметического ремонта (в т.ч. под чистовую отделку)': 1.08,
        'аналог_требует капитального ремонта (в т.ч. без отделки)': 1.19,
      },
      'требует косметического ремонта (в т.ч. под чистовую отделку)': {
        'аналог_комфортный ремонт (отделка «премиум»)': 0.82,
        'аналог_типовой ремонт (отделка «стандарт»)': 0.92,
        'аналог_требует косметического ремонта (в т.ч. под чистовую отделку)': 1.0,
        'аналог_требует капитального ремонта (в т.ч. без отделки)': 1.10,
      },
      'требует капитального ремонта (в т.ч. без отделки)': {
        'аналог_комфортный ремонт (отделка «премиум»)': 0.74,
        'аналог_типовой ремонт (отделка «стандарт»)': 0.84,
        'аналог_требует косметического ремонта (в т.ч. под чистовую отделку)': 0.91,
        'аналог_требует капитального ремонта (в т.ч. без отделки)': 1.0,
      },
    },
  },
  'Города с численностью населения 500-1000 тыс. человек': {
    'объект_оценки': {
      'комфортный ремонт (отделка «премиум»)': {
        'аналог_комфортный ремонт (отделка «премиум»)': 1.0,
        'аналог_типовой ремонт (отделка «стандарт»)': 1.13,
        'аналог_требует косметического ремонта (в т.ч. под чистовую отделку)': 1.22,
        'аналог_требует капитального ремонта (в т.ч. без отделки)': 1.33,
      },
      'типовой ремонт (отделка «стандарт»)': {
        'аналог_комфортный ремонт (отделка «премиум»)': 0.89,
        'аналог_типовой ремонт (отделка «стандарт»)': 1.0,
        'аналог_требует косметического ремонта (в т.ч. под чистовую отделку)': 1.18,
        'аналог_требует капитального ремонта (в т.ч. без отделки)': 1.18,
      },
      'требует косметического ремонта (в т.ч. под чистовую отделку)': {
        'аналог_комфортный ремонт (отделка «премиум»)': 0.82,
        'аналог_типовой ремонт (отделка «стандарт»)': 0.92,
        'аналог_требует косметического ремонта (в т.ч. под чистовую отделку)': 1.0,
        'аналог_требует капитального ремонта (в т.ч. без отделки)': 1.09,
      },
      'требует капитального ремонта (в т.ч. без отделки)': {
        'аналог_комфортный ремонт (отделка «премиум»)': 0.75,
        'аналог_типовой ремонт (отделка «стандарт»)': 0.85,
        'аналог_требует косметического ремонта (в т.ч. под чистовую отделку)': 0.92,
        'аналог_требует капитального ремонта (в т.ч. без отделки)': 1.0,
      },
    },
  },
  'Города с численностью населения менее 500 тыс. человек': {
    'объект_оценки': {
      'комфортный ремонт (отделка «премиум»)': {
        'аналог_комфортный ремонт (отделка «премиум»)': 1.0,
        'аналог_типовой ремонт (отделка «стандарт»)': 1.14,
        'аналог_требует косметического ремонта (в т.ч. под чистовую отделку)': 1.20,
        'аналог_требует капитального ремонта (в т.ч. без отделки)': 1.38,
      },
      'типовой ремонт (отделка «стандарт»)': {
        'аналог_комфортный ремонт (отделка «премиум»)': 0.88,
        'аналог_типовой ремонт (отделка «стандарт»)': 1.0,
        'аналог_требует косметического ремонта (в т.ч. под чистовую отделку)': 0.06,
        'аналог_требует капитального ремонта (в т.ч. без отделки)': 1.21,
      },
      'требует косметического ремонта (в т.ч. под чистовую отделку)': {
        'аналог_комфортный ремонт (отделка «премиум»)': 0.83,
        'аналог_типовой ремонт (отделка «стандарт»)': 0.95,
        'аналог_требует косметического ремонта (в т.ч. под чистовую отделку)': 1.0,
        'аналог_требует капитального ремонта (в т.ч. без отделки)': 1.15,
      },
      'требует капитального ремонта (в т.ч. без отделки)': {
        'аналог_комфортный ремонт (отделка «премиум»)': 0.72,
        'аналог_типовой ремонт (отделка «стандарт»)': 0.82,
        'аналог_требует косметического ремонта (в т.ч. под чистовую отделку)': 0.87,
        'аналог_требует капитального ремонта (в т.ч. без отделки)': 1.0,
      },
    },
  },
  'Курортные регионы': {
    'объект_оценки': {
      'комфортный ремонт (отделка «премиум»)': {
        'аналог_комфортный ремонт (отделка «премиум»)': 1.0,
        'аналог_типовой ремонт (отделка «стандарт»)': 1.15,
        'аналог_требует косметического ремонта (в т.ч. под чистовую отделку)': 1.26,
        'аналог_требует капитального ремонта (в т.ч. без отделки)': 1.41,
      },
      'типовой ремонт (отделка «стандарт»)': {
        'аналог_комфортный ремонт (отделка «премиум»)': 0.87,
        'аналог_типовой ремонт (отделка «стандарт»)': 1.0,
        'аналог_требует косметического ремонта (в т.ч. под чистовую отделку)': 1.23,
        'аналог_требует капитального ремонта (в т.ч. без отделки)': null,
      },
      'требует косметического ремонта (в т.ч. под чистовую отделку)': {
        'аналог_комфортный ремонт (отделка «премиум»)': 0.79,
        'аналог_типовой ремонт (отделка «стандарт»)': 0.91,
        'аналог_требует косметического ремонта (в т.ч. под чистовую отделку)': 1.0,
        'аналог_требует капитального ремонта (в т.ч. без отделки)': null,
      },
      'требует капитального ремонта (в т.ч. без отделка)': {
        'аналог_комфортный ремонт (отделка «премиум»)': 0.71,
        'аналог_типовой ремонт (отделка «стандарт»)': 0.81,
        'аналог_требует косметического ремонта (в т.ч. под чистовую отделку)': 1.0,
        'аналог_требует капитального ремонта (в т.ч. без отделки)': null,
      },
    },
  },
};

export const REGION_ALIASES_FOR_FLAT_CONDITION = {
  'Города с численностью населения более 1 млн чел. (кроме Москвы и Санкт-Петербурга)': 'Города с численностью населения более 1 млн человек (кроме Москвы и Санкт-Петербурга)',
  'Города с численностью населения 500-1000 тыс. чел.': 'Города с численностью населения 500-1000 тыс. человек',
  'Города с численностью населения до 500 тыс. чел.': 'Города с численностью населения менее 500 тыс. человек',
};

export const BALCONY_COEFFICIENTS = {
  'москва': {
    'объект_есть_аналог_есть': 1.0,
    'объект_есть_аналог_нет': 1.09,
    'объект_нет_аналог_есть': 0.92,
    'объект_нет_аналог_нет': 1.0,
  },
  'московская_область': {
    'объект_есть_аналог_есть': 1.0,
    'объект_есть_аналог_нет': 1.08,
    'объект_нет_аналог_есть': 0.93,
    'объект_нет_аналог_нет': 1.0,
  },
  'города_более_1_млн': {
    'объект_есть_аналог_есть': 1.0,
    'объект_есть_аналог_нет': 1.08,
    'объект_нет_аналог_есть': 0.93,
    'объект_нет_аналог_нет': 1.0,
  },
  'города_500_1000_тыс': {
    'объект_есть_аналог_есть': 1.0,
    'объект_есть_аналог_нет': 1.08,
    'объект_нет_аналог_есть': 0.92,
    'объект_нет_аналог_нет': 1.0,
  },
  'города_до_500_тыс': {
    'объект_есть_аналог_есть': 1.0,
    'объект_есть_аналог_нет': 1.08,
    'объект_нет_аналог_есть': 0.93,
    'объект_нет_аналог_нет': 0.0,
  },
  'курортные_регионы': {
    'объект_есть_аналог_есть': 1.0,
    'объект_есть_аналог_нет': 1.10,
    'объект_нет_аналог_есть': 0.91,
    'объект_нет_аналог_нет': 1.0,
  },
};

export const REGION_ALIASES_FOR_BALCONY = {
  'Москва': 'москва',
  'Московская область': 'московская_область',
  'Города с численностью населения более 1 млн чел. (кроме Москвы и Санкт-Петербурга)': 'города_более_1_млн',
  'Города с численностью населения более 1 млн человек (кроме Москвы и Санкт-Петербурга)': 'города_более_1_млн',
  'Города с численностью населения 500-1000 тыс. чел.': 'города_500_1000_тыс',
  'Города с численностью населения 500-1000 тыс. человек': 'города_500_1000_тыс',
  'Города с численностью населения до 500 тыс. чел.': 'города_до_500_тыс',
  'Города с численностью населения менее 500 тыс. человек': 'города_до_500_тыс',
  'Курортные регионы': 'курортные_регионы',
};

export const FLOOR_COEFFICIENTS = {
  "Москва": {
    "Старый фонд, Массовое жилье советской постройки": {
      "объект_оценки": {
        "средний этаж": {
          "аналог_средний этаж": 1.00,
          "аналог_последний этаж": 0.98,
          "аналог_первый этаж": 1.04
        },
        "последний этаж": {
          "аналог_средний этаж": 1.02,
          "аналог_последний этаж": 1.00,
          "аналог_первый этаж": 1.06
        },
        "первый этаж": {
          "аналог_средний этаж": 0.96,
          "аналог_последний этаж": 0.94,
          "аналог_первый этаж": 1.00
        }
      }
    },
    "Массовое современное жилье, Жилье повышенной комфортности": {
      "объект_оценки": {
        "средний этаж": {
          "аналог_средний этаж": 1.00,
          "аналог_последний этаж": 1.05,
          "аналог_первый этаж": 1.14
        },
        "последний этаж": {
          "аналог_средний этаж": 0.95,
          "аналог_последний этаж": 1.00,
          "аналог_первый этаж": 1.08
        },
        "первый этаж": {
          "аналог_средний этаж": 0.88,
          "аналог_последний этаж": 0.93,
          "аналог_первый этаж": 1.00
        }
      }
    },
    "Старый фонд, Массовое жилье советской постройки, Массовое современное жилье (маневральный/цокольный)": {
      "объект_оценки": {
        "средний этаж": {
          "аналог_средний этаж": 1.00,
          "аналог_маневральный этаж": 1.08,
          "аналог_цокольный этаж": 1.13
        },
        "маневральный этаж": {
          "аналог_средний этаж": 0.93,
          "аналог_маневральный этаж": 1.00,
          "аналог_цокольный этаж": 1.04
        },
        "цокольный этаж": {
          "аналог_средний этаж": 0.89,
          "аналог_маневральный этаж": 0.96,
          "аналог_цокольный этаж": 1.00
        }
      }
    }
  },
  "Московская область": {
    "Старый фонд, Массовое жилье советской постройки": {
      "объект_оценки": {
        "средний этаж": {
          "аналог_средний этаж": 1.00,
          "аналог_последний этаж": 0.97,
          "аналог_первый этаж": 1.05
        },
        "последний этаж": {
          "аналог_средний этаж": 1.03,
          "аналог_последний этаж": 1.00,
          "аналог_первый этаж": 1.08
        },
        "первый этаж": {
          "аналог_средний этаж": 0.95,
          "аналог_последний этаж": 0.93,
          "аналог_первый этаж": 1.00
        }
      }
    },
    "Массовое современное жилье, Жилье повышенной комфортности": {
      "объект_оценки": {
        "средний этаж": {
          "аналог_средний этаж": 1.00,
          "аналог_последний этаж": 1.05,
          "аналог_первый этаж": 1.08
        },
        "последний этаж": {
          "аналог_средний этаж": 0.96,
          "аналог_последний этаж": 1.00,
          "аналог_первый этаж": 1.04
        },
        "первый этаж": {
          "аналог_средний этаж": 0.92,
          "аналог_последний этаж": 0.96,
          "аналог_первый этаж": 1.00
        }
      }
    },
    "Старый фонд, Массовое жилье советской постройки, Массовое современное жилье (маневральный/цокольный)": {
      "объект_оценки": {
        "средний этаж": {
          "аналог_средний этаж": 1.00,
          "аналог_маневральный этаж": 1.07,
          "аналог_цокольный этаж": 1.12
        },
        "маневральный этаж": {
          "аналог_средний этаж": 0.93,
          "аналог_маневральный этаж": 1.00,
          "аналог_цокольный этаж": 1.05
        },
        "цокольный этаж": {
          "аналог_средний этаж": 0.89,
          "аналог_маневральный этаж": 0.95,
          "аналог_цокольный этаж": 1.00
        }
      }
    }
  },
  "Санкт-Петербург": {
    "Старый фонд, Массовое жилье советской постройки": {
      "объект_оценки": {
        "средний этаж": {
          "аналог_средний этаж": 1.00,
          "аналог_последний этаж": 0.98,
          "аналог_первый этаж": 1.05
        },
        "последний этаж": {
          "аналог_средний этаж": 1.02,
          "аналог_последний этаж": 1.00,
          "аналог_первый этаж": 1.07
        },
        "первый этаж": {
          "аналог_средний этаж": 0.95,
          "аналог_последний этаж": 0.93,
          "аналог_первый этаж": 1.00
        }
      }
    },
    "Массовое современное жилье, Жилье повышенной комфортности": {
      "объект_оценки": {
        "средний этаж": {
          "аналог_средний этаж": 1.00,
          "аналог_последний этаж": 1.01,
          "аналог_первый этаж": 1.15
        },
        "последний этаж": {
          "аналог_средний этаж": 0.99,
          "аналог_последний этаж": 1.00,
          "аналог_первый этаж": 1.14
        },
        "первый этаж": {
          "аналог_средний этаж": 0.87,
          "аналог_последний этаж": 0.88,
          "аналог_первый этаж": 1.00
        }
      }
    },
    "Старый фонд, Массовое жилье советской постройки, Массовое современное жилье (маневральный/цокольный)": {
      "объект_оценки": {
        "средний этаж": {
          "аналог_средний этаж": 1.00,
          "аналог_маневральный этаж": 1.09,
          "аналог_цокольный этаж": 1.13
        },
        "маневральный этаж": {
          "аналог_средний этаж": 0.92,
          "аналог_маневральный этаж": 1.00,
          "аналог_цокольный этаж": 1.04
        },
        "цокольный этаж": {
          "аналог_средний этаж": 0.88,
          "аналог_маневральный этаж": 0.96,
          "аналог_цокольный этаж": 1.00
        }
      }
    }
  },
  "Города с численностью населения более 1 млн человек (кроме Москвы и Санкт-Петербурга)": {
    "Старый фонд, Массовое жилье советской постройки": {
      "объект_оценки": {
        "средний этаж": {
          "аналог_средний этаж": 1.00,
          "аналог_последний этаж": 1.04,
          "аналог_первый этаж": 1.06
        },
        "последний этаж": {
          "аналог_средний этаж": 0.96,
          "аналог_последний этаж": 1.00,
          "аналог_первый этаж": 1.02
        },
        "первый этаж": {
          "аналог_средний этаж": 0.94,
          "аналог_последний этаж": 0.98,
          "аналог_первый этаж": 1.00
        }
      }
    },
    "Массовое современное жилье, Жилье повышенной комфортности": {
      "объект_оценки": {
        "средний этаж": {
          "аналог_средний этаж": 1.00,
          "аналог_последний этаж": 1.02,
          "аналог_первый этаж": 1.10
        },
        "последний этаж": {
          "аналог_средний этаж": 0.98,
          "аналог_последний этаж": 1.00,
          "аналог_первый этаж": 1.08
        },
        "первый этаж": {
          "аналог_средний этаж": 0.91,
          "аналог_последний этаж": 0.93,
          "аналог_первый этаж": 1.00
        }
      }
    },
    "Старый фонд, Массовое жилье советской постройки, Массовое современное жилье (маневральный/цокольный)": {
      "объект_оценки": {
        "средний этаж": {
          "аналог_средний этаж": 1.00,
          "аналог_маневральный этаж": 1.10,
          "аналог_цокольный этаж": 1.15
        },
        "маневральный этаж": {
          "аналог_средний этаж": 0.91,
          "аналог_маневральный этаж": 1.00,
          "аналог_цокольный этаж": 1.05
        },
        "цокольный этаж": {
          "аналог_средний этаж": 0.87,
          "аналог_маневральный этаж": 0.96,
          "аналог_цокольный этаж": 1.00
        }
      }
    }
  },
  "Города с численностью населения 500-1000 тыс. человек": {
    "Старый фонд, Массовое жилье советской постройки": {
      "объект_оценки": {
        "средний этаж": {
          "аналог_средний этаж": 1.00,
          "аналог_последний этаж": 1.04,
          "аналог_первый этаж": 1.05
        },
        "последний этаж": {
          "аналог_средний этаж": 0.96,
          "аналог_последний этаж": 1.00,
          "аналог_первый этаж": 1.01
        },
        "первый этаж": {
          "аналог_средний этаж": 0.95,
          "аналог_последний этаж": 0.99,
          "аналог_первый этаж": 1.00
        }
      }
    },
    "Массовое современное жилье, Жилье повышенной комфортности": {
      "объект_оценки": {
        "средний этаж": {
          "аналог_средний этаж": 1.00,
          "аналог_последний этаж": 1.01,
          "аналог_первый этаж": 1.15
        },
        "последний этаж": {
          "аналог_средний этаж": 0.99,
          "аналог_последний этаж": 1.00,
          "аналог_первый этаж": 1.14
        },
        "первый этаж": {
          "аналог_средний этаж": 0.87,
          "аналог_последний этаж": 0.88,
          "аналог_первый этаж": 1.00
        }
      }
    },
    "Старый фонд, Массовое жилье советской постройки, Массовое современное жилье (маневральный/цокольный)": {
      "объект_оценки": {
        "средний этаж": {
          "аналог_средний этаж": 1.00,
          "аналог_маневральный этаж": 1.07,
          "аналог_цокольный этаж": 1.12
        },
        "маневральный этаж": {
          "аналог_средний этаж": 0.94,
          "аналог_маневральный этаж": 1.00,
          "аналог_цокольный этаж": 1.05
        },
        "цокольный этаж": {
          "аналог_средний этаж": 0.89,
          "аналог_маневральный этаж": 0.95,
          "аналог_цокольный этаж": 1.00
        }
      }
    }
  },
  "Города с численностью населения менее 500 тыс. человек": {
    "Старый фонд, Массовое жилье советской постройки": {
      "объект_оценки": {
        "средний этаж": {
          "аналог_средний этаж": 1.00,
          "аналог_последний этаж": 1.03,
          "аналог_первый этаж": 1.09
        },
        "последний этаж": {
          "аналог_средний этаж": 0.97,
          "аналог_последний этаж": 1.00,
          "аналог_первый этаж": 1.06
        },
        "первый этаж": {
          "аналог_средний этаж": 0.92,
          "аналог_последний этаж": 0.94,
          "аналог_первый этаж": 1.00
        }
      }
    },
    "Массовое современное жилье, Жилье повышенной комфортности": {
      "объект_оценки": {
        "средний этаж": {
          "аналог_средний этаж": 1.00,
          "аналог_последний этаж": 1.02,
          "аналог_первый этаж": 1.11
        },
        "последний этаж": {
          "аналог_средний этаж": 0.98,
          "аналог_последний этаж": 1.00,
          "аналог_первый этаж": 1.09
        },
        "первый этаж": {
          "аналог_средний этаж": 0.90,
          "аналог_последний этаж": 0.92,
          "аналог_первый этаж": 1.00
        }
      }
    },
    "Старый фонд, Массовое жилье советской постройки, Массовое современное жилье (маневральный/цокольный)": {
      "объект_оценки": {
        "средний этаж": {
          "аналог_средний этаж": 1.00,
          "аналог_маневральный этаж": 1.09,
          "аналог_цокольный этаж": 1.14
        },
        "маневральный этаж": {
          "аналог_средний этаж": 0.92,
          "аналог_маневральный этаж": 1.00,
          "аналог_цокольный этаж": 1.04
        },
        "цокольный этаж": {
          "аналог_средний этаж": 0.88,
          "аналог_маневральный этаж": 0.96,
          "аналог_цокольный этаж": 1.00
        }
      }
    }
  },
  "Курортные регионы": {
    "Старый фонд, Массовое жилье советской постройки": {
      "объект_оценки": {
        "средний этаж": {
          "аналог_средний этаж": 1.00,
          "аналог_последний этаж": 1.03,
          "аналог_первый этаж": 1.09
        },
        "последний этаж": {
          "аналог_средний этаж": 0.97,
          "аналог_последний этаж": 1.00,
          "аналог_первый этаж": 1.05
        },
        "первый этаж": {
          "аналог_средний этаж": 0.92,
          "аналог_последний этаж": 0.95,
          "аналог_первый этаж": 1.00
        }
      }
    },
    "Массовое современное жилье, Жилье повышенной комфортности": {
      "объект_оценки": {
        "средний этаж": {
          "аналог_средний этаж": 1.00,
          "аналог_последний этаж": 1.02,
          "аналог_первый этаж": 1.09
        },
        "последний этаж": {
          "аналог_средний этаж": 0.98,
          "аналог_последний этаж": 1.00,
          "аналог_первый этаж": 1.07
        },
        "первый этаж": {
          "аналог_средний этаж": 0.92,
          "аналог_последний этаж": 0.93,
          "аналог_первый этаж": 1.00
        }
      }
    },
    "Старый фонд, Массовое жилье советской постройки, Массовое современное жилье (маневральный/цокольный)": {
      "объект_оценки": {
        "средний этаж": {
          "аналог_средний этаж": 1.00,
          "аналог_маневральный этаж": 1.09,
          "аналог_цокольный этаж": 1.14
        },
        "маневральный этаж": {
          "аналог_средний этаж": 0.91,
          "аналог_маневральный этаж": 1.00,
          "аналог_цокольный этаж": 1.04
        },
        "цокольный этаж": {
          "аналог_средний этаж": 0.88,
          "аналог_маневральный этаж": 0.96,
          "аналог_цокольный этаж": 1.00
        }
      }
    }
  }
};

export const REGION_ALIASES_FOR_FLOORS = {
  'Города с численностью населения более 1 млн чел. (кроме Москвы и Санкт-Петербурга)': 'Города с численностью населения более 1 млн человек (кроме Москвы и Санкт-Петербурга)',
  'Города с численностью населения 500-1000 тыс. чел.': 'Города с численностью населения 500-1000 тыс. человек',
  'Города с численностью населения до 500 тыс. чел.': 'Города с численностью населения менее 500 тыс. человек',
};

// === ВСПОМОГАТЕЛЬНЫЕ ФУНКЦИИ ДЛЯ СТЕН (БЕЗ РЕГИОНА) ===

/**
 * Определяет группу фонда для стен (без региона!)
 */
export function resolveWallFundGroupKey(selectedFund) {
  if (!selectedFund) return null;
  if (selectedFund === 'Старый фонд') {
    return 'Старый фонд';
  }
  return 'Массовое жилье советской постройки, Массовое современное жилье, Жилье повышенной комфортности';
}

/**
 * Варианты материала стен для объекта оценки
 */
export function getEvalWallOptions(fundKey) {
  const group = AVERAGE_WALL_MATERIAL_COEFFICIENTS[fundKey];
  return group ? Object.keys(group) : [];
}

/**
 * Варианты материала стен для аналога
 */
export function getAnalogWallOptions(fundKey, evalWall) {
  const mapping = AVERAGE_WALL_MATERIAL_COEFFICIENTS[fundKey]?.[evalWall];
  return mapping ? Object.keys(mapping) : [];
}

/**
 * Расчёт множителя для материала стен (без региона!)
 */
export function calcWallsMultiplier(fundKey, evalWall, analogWall) {
  const value = AVERAGE_WALL_MATERIAL_COEFFICIENTS[fundKey]?.[evalWall]?.[analogWall];
  return Number.isFinite(value) ? Math.round(value * 10000) / 10000 : null;
}

export function resolveLocationRegionKey(selectedRegion) {
  if (LOCATION_COEFFICIENTS[selectedRegion]) return selectedRegion;
  const alias = REGION_ALIASES_FOR_LOCATION[selectedRegion];
  return alias && LOCATION_COEFFICIENTS[alias] ? alias : null;
}

export function resolveLocationFundGroupKey(selectedFund) {
  if (selectedFund === 'Жилье повышенной комфортности') return 'Жилые повышенной комфортности';
  return 'Старый фонд, Массовое жилье советской постройки, Массовое современное жилье';
}

export function resolveHouseConditionRegionKey(selectedRegion) {
  if (HOUSE_CONDITION_COEFFICIENTS[selectedRegion]) return selectedRegion;
  const alias = REGION_ALIASES_FOR_HOUSE_CONDITION[selectedRegion];
  return alias && HOUSE_CONDITION_COEFFICIENTS[alias] ? alias : null;
}

export function resolveHouseConditionFundGroupKey(selectedFund) {
  return 'Старый фонд, Массовое жилье советской постройки, Массовое современное жилье';
}

export function getEvalHouseConditionOptions(regionKey, fundKey) {
  const group = HOUSE_CONDITION_COEFFICIENTS[regionKey]?.[fundKey]?.['объект_оценки'];
  return group ? Object.keys(group) : [];
}

export function getAnalogHouseConditionOptions(regionKey, fundKey, evalCondition) {
  const mapping = HOUSE_CONDITION_COEFFICIENTS[regionKey]?.[fundKey]?.['объект_оценки']?.[evalCondition];
  if (!mapping) return [];
  return Object.keys(mapping).map((k) => k.replace(/^аналог_/, ''));
}

export function calcHouseConditionMultiplier(regionKey, fundKey, evalCondition, analogCondition) {
  const analogKey = `аналог_${analogCondition}`;
  const value = HOUSE_CONDITION_COEFFICIENTS[regionKey]?.[fundKey]?.['объект_оценки']?.[evalCondition]?.[analogKey];
  return Number.isFinite(value) ? Math.round(value * 10000) / 10000 : null;
}

export function resolveFlatConditionRegionKey(selectedRegion) {
  if (FLAT_CONDITION_COEFFICIENTS[selectedRegion]) return selectedRegion;
  const alias = REGION_ALIASES_FOR_FLAT_CONDITION[selectedRegion];
  return alias && FLAT_CONDITION_COEFFICIENTS[alias] ? alias : null;
}

export function getEvalFlatConditionOptions(regionKey) {
  const group = FLAT_CONDITION_COEFFICIENTS[regionKey]?.['объект_оценки'];
  return group ? Object.keys(group) : [];
}

export function getAnalogFlatConditionOptions(regionKey, evalCondition) {
  const mapping = FLAT_CONDITION_COEFFICIENTS[regionKey]?.['объект_оценки']?.[evalCondition];
  if (!mapping) return [];
  return Object.keys(mapping).map((k) => k.replace(/^аналог_/, ''));
}

export function calcFlatConditionMultiplier(regionKey, evalCondition, analogCondition) {
  const analogKey = `аналог_${analogCondition}`;
  const value = FLAT_CONDITION_COEFFICIENTS[regionKey]?.['объект_оценки']?.[evalCondition]?.[analogKey];
  return Number.isFinite(value) ? Math.round(value * 10000) / 10000 : null;
}

export function resolveBalconyRegionKey(selectedRegion) {
  const key = REGION_ALIASES_FOR_BALCONY[selectedRegion];
  return key && BALCONY_COEFFICIENTS[key] ? key : null;
}

export function calcBalconyMultiplier(balconyRegionKey, evalHasBalcony, analogHasBalcony) {
  if (!balconyRegionKey) return null;
  const k = `${evalHasBalcony ? 'объект_есть' : 'объект_нет'}_${analogHasBalcony ? 'аналог_есть' : 'аналог_нет'}`;
  const value = BALCONY_COEFFICIENTS[balconyRegionKey]?.[k];
  return Number.isFinite(value) ? Math.round(value * 10000) / 10000 : null;
}

export function resolveFloorRegionKey(selectedRegion) {
  if (FLOOR_COEFFICIENTS[selectedRegion]) return selectedRegion;
  const alias = REGION_ALIASES_FOR_FLOORS[selectedRegion];
  return alias && FLOOR_COEFFICIENTS[alias] ? alias : null;
}

export function resolveFloorFundGroupKey(selectedFund) {
  if (selectedFund === 'Старый фонд' || selectedFund === 'Массовое жилье советской постройки') {
    return 'Старый фонд, Массовое жилье советской постройки';
  }
  if (selectedFund === 'Массовое современное жилье' || selectedFund === 'Жилье повышенной комфортности') {
    return 'Массовое современное жилье, Жилье повышенной комфортности';
  }
  return null;
}

export function getEvalFloorOptions(regionKey, fundKey) {
  const group = FLOOR_COEFFICIENTS[regionKey]?.[fundKey]?.['объект_оценки'];
  if (!group) return [];
  const hasManevralnyGroup = FLOOR_COEFFICIENTS[regionKey]?.['Старый фонд, Массовое жилье советской постройки, Массовое современное жилье (маневральный/цокольный)'];
  const baseOptions = Object.keys(group);
  if (hasManevralnyGroup) {
    const manOptions = Object.keys(hasManevralnyGroup['объект_оценки'] || {});
    return [...new Set([...baseOptions, ...manOptions])];
  }
  return baseOptions;
}

export function getAnalogFloorOptions(regionKey, fundKey, evalFloor) {
  let mapping = FLOOR_COEFFICIENTS[regionKey]?.[fundKey]?.['объект_оценки']?.[evalFloor];
  if (!mapping) {
    const manGroup = FLOOR_COEFFICIENTS[regionKey]?.['Старый фонд, Массовое жилье советской постройки, Массовое современное жилье (маневральный/цокольный)'];
    mapping = manGroup?.['объект_оценки']?.[evalFloor];
  }
  if (!mapping) return [];
  return Object.keys(mapping).map((k) => k.replace(/^аналог_/, ''));
}

export function calcFloorMultiplier(regionKey, fundKey, evalFloor, analogFloor) {
  const analogKey = `аналог_${analogFloor}`;
  let value = FLOOR_COEFFICIENTS[regionKey]?.[fundKey]?.['объект_оценки']?.[evalFloor]?.[analogKey];
  if (!Number.isFinite(value)) {
    const manGroup = FLOOR_COEFFICIENTS[regionKey]?.['Старый фонд, Массовое жилье советской постройки, Массовое современное жилье (маневральный/цокольный)'];
    value = manGroup?.['объект_оценки']?.[evalFloor]?.[analogKey];
  }
  return Number.isFinite(value) ? Math.round(value * 10000) / 10000 : null;
}